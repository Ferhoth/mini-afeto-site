<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedido - Mini Afeto Magnéticos</title>
  <link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
  <style>
    body { font-family: Arial, sans-serif; background: #fdf6f0; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: auto; padding: 40px 20px; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 10px; }
    h1 { text-align: center; color: #ff6f91; }
    input, button, select { display: block; width: 100%; margin: 10px 0; padding: 10px; font-size: 1em; }
    #preview { max-width: 100%; max-height: 300px; margin-top: 10px; }
    #cropped-preview { margin-top: 20px; }
    button { background: #ff6f91; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #ff4f70; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Finalizar Pedido</h1>

    <form id="pedido-form">
      <label>Nome completo:</label>
      <input type="text" name="nome" required>

      <label>Email:</label>
      <input type="email" name="email" required>

      <label>Quantidade de ímãs:</label>
      <select name="quantidade" required>
        <option value="9">9 Ímãs</option>
        <option value="18">18 Ímãs</option>
        <option value="27">27 Ímãs</option>
      </select>

      <label>Enviar uma imagem (opcional):</label>
      <input type="file" id="image-upload" accept="image/*">
      <img id="preview">
      <div id="cropped-preview"></div>

      <button type="submit">Enviar Pedido</button>
    </form>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
  <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>

  <script>
    // TODO: Substitua com suas credenciais do Firebase
    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SEU_DOMINIO.firebaseapp.com",
      projectId: "SEU_PROJETO_ID",
      storageBucket: "SEU_BUCKET.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();
    const functions = firebase.functions();

    const imageUpload = document.getElementById('image-upload');
    const preview = document.getElementById('preview');
    const croppedPreview = document.getElementById('cropped-preview');
    let cropper;

    imageUpload.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        preview.src = event.target.result;
        if (cropper) cropper.destroy();
        cropper = new Cropper(preview, {
          aspectRatio: 1,
          viewMode: 1
        });
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('pedido-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const form = e.target;
      const nome = form.nome.value;
      const email = form.email.value;
      const quantidade = form.quantidade.value;
      let imageUrl = null;

      if (cropper) {
        const canvas = cropper.getCroppedCanvas({ width: 500, height: 500 });
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
        const storageRef = storage.ref().child('pedidos/' + Date.now() + '.jpg');
        const snapshot = await storageRef.put(blob);
        imageUrl = await snapshot.ref.getDownloadURL();
      }

      const pedido = { nome, email, quantidade, imagem: imageUrl };

      // Chamada para a cloud function (a ser criada no backend Firebase)
      const enviarPedido = functions.httpsCallable('enviarPedido');
      try {
        await enviarPedido(pedido);
        alert('Pedido enviado com sucesso!');
        form.reset();
        if (cropper) {
          cropper.destroy();
          preview.src = '';
          croppedPreview.innerHTML = '';
        }
      } catch (error) {
        console.error('Erro ao enviar pedido:', error);
        alert('Erro ao enviar pedido. Tente novamente.');
      }
    });
  </script>
</body>
</html>
